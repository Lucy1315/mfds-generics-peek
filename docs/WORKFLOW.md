# MFDS Matching Dashboard — 워크플로우 및 사용방법

## 1. 개요

MFDS Matching Dashboard는 의약품 허가 품목 데이터(Raw Excel)와 식약처(MFDS) 마스터 데이터를 자동으로 매칭하여, 각 품목의 허가 여부 및 제네릭(후발) 의약품 수를 산출하는 도구입니다.

---

## 2. 워크플로우

```
┌─────────────────────┐
│  1. 파일 업로드      │
│  (Raw + MFDS + Map) │
└────────┬────────────┘
         ▼
┌─────────────────────┐
│  2. 파일 진단        │
│  (컬럼 확인/시트선택)│
└────────┬────────────┘
         ▼
┌─────────────────────┐
│  3. 옵션 설정        │
│  (제네릭 기준 등)    │
└────────┬────────────┘
         ▼
┌─────────────────────┐
│  4. Process 실행     │
│  (매칭 + 집계)       │
└────────┬────────────┘
         ▼
┌─────────────────────┐
│  5. 결과 확인        │
│  (테이블 + 제네릭)   │
└────────┬────────────┘
         ▼
┌─────────────────────┐
│  6. Excel 다운로드   │
│  (5개 시트 출력)     │
└─────────────────────┘
```

---

## 3. 입력 파일 설명

### 3.1 Raw Excel (필수)

| 필수 컬럼 | 설명 |
|-----------|------|
| `Product` | 제품명 (영문 또는 한글) |
| `순번` | 고유 식별번호 |

- 기타 컬럼은 그대로 결과에 포함됩니다.

### 3.2 MFDS Master Excel (필수)

| 필수 컬럼 | 설명 |
|-----------|------|
| `제품명` | 한글 제품명 |
| `제품영문명` | 영문 제품명 |
| `주성분` | 성분명 (한글+영문) |
| `신약구분` | 'Y' = 신약 |
| `취소취하` | 취소/취하 여부 |
| `허가일자` | 허가 날짜 |
| `제형` | 제형 (정제, 캡슐 등) |

- 선택 컬럼: `품목기준코드`, `업체명`

### 3.3 Mapping Excel (선택)

사전 매핑 테이블로, 자동 매칭 정확도를 높입니다.

| 컬럼 | 설명 |
|------|------|
| `Product_code_token` | Raw Product에서 추출한 코드 토큰 |
| `mapped_mfds_item_code` | MFDS 품목기준코드 |
| `mapped_ingredient_base` | 매핑된 성분 base key |
| `mapped_mfds_product_name` | 매핑된 MFDS 제품명 |

---

## 4. 옵션 설정

### Generic Count Basis (제네릭 집계 기준)
- **Base ingredient only** (`base`): 주성분 기준으로만 집계
- **Base + Dosage form** (`base_form`): 주성분 + 제형 기준으로 집계

### Generic Definition (제네릭 정의)
- **Exclude original** (`excl_original`): 원개발 의약품 제외
- **Total minus original** (`total_minus_original`): 전체에서 원개발 차감

### Cancel Filter (취소/취하 필터)
- **Active only** (`active_only`): 취소/취하된 품목 제외
- **All** (`all`): 취소/취하 포함

### Review Threshold (검토 임계값)
- 매칭 점수가 이 값 미만이면 "검토필요"로 표시 (기본: 0.90)

---

## 5. 결과 해석

### 5.1 Summary Cards
- **Total**: 처리된 총 행 수
- **High**: 매칭 신뢰도 높음
- **Medium**: 중간 신뢰도
- **Review**: 검토 필요
- **Not Found**: 매칭 실패
- **Generic Items**: 식별된 제네릭 품목 총 수

### 5.2 Results Table 컬럼

| 컬럼 | 설명 |
|------|------|
| 순번 | 원본 식별번호 |
| Product | 원본 제품명 |
| MFDS_제품명 | 매칭된 MFDS 제품명 |
| Ingredient (Eng) | 영문 성분명 |
| Ingredient_base | 정규화된 성분 base key |
| 허가여부 | 원개발 의약품 여부 (Y/N) |
| Generic 수 | 해당 성분의 제네릭 품목 수 |
| 매칭상태 | high / medium / review / not_found |
| 매칭점수 | 0~1 범위의 유사도 점수 |

### 5.3 Generic Items 탭
- Results 테이블에서 행을 클릭하면 해당 품목의 제네릭 목록이 표시됩니다.
- 각 제네릭의 제품명, 영문명, 업체명, 제형, 허가일 등을 확인할 수 있습니다.

---

## 6. Excel 출력 시트 구성

| 시트명 | 내용 |
|--------|------|
| `results` | 전체 매칭 결과 (1행 = 1 소스 품목) |
| `summary` | 요약 통계 |
| `generic_items` | 제네릭 품목 상세 (1행 = 1 제네릭 제품) |
| `generic_list_compact` | 소스별 제네릭 요약 (제품명 join) |
| `mapping_used` | 사용된 매핑 데이터 (매핑 파일 업로드 시) |

---

## 7. 검증 로직

- **Consistency Check**: `generic_제품수`와 `generic_items` 시트의 실제 행 수가 일치하는지 자동 검증
- 불일치 발견 시 오류 토스트 및 콘솔 로그 출력
- Summary에 `total_generic_item_rows`, `max_generic_per_source`, `average_generic_per_source` 포함

---

## 8. 주의사항

1. Excel 파일은 `.xlsx` 또는 `.xls` 형식만 지원합니다.
2. 대용량 파일(10만 행 이상)은 처리 시간이 길어질 수 있습니다.
3. 주성분 정규화는 괄호, 특수문자, 농도 정보를 제거하여 수행됩니다.
4. Mapping 파일은 선택사항이지만, 사용 시 매칭 정확도가 크게 향상됩니다.
5. 취소/취하 필터 변경 시 MFDS 파일이 자동으로 재진단됩니다.

---

## 9. 트러블슈팅

### 9.1 파일 업로드 오류

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| "필수 컬럼 누락" 오류 | 컬럼명이 정확히 일치하지 않음 | 컬럼명의 공백, 대소문자 확인. `Product`(대문자 P), `순번` 등 정확히 일치해야 함 |
| 파일 업로드 후 아무 반응 없음 | 지원하지 않는 파일 형식 | `.xlsx` 또는 `.xls` 파일인지 확인 |
| "시트를 찾을 수 없습니다" | 빈 시트 또는 잘못된 시트 | 다중 시트 파일의 경우 진단 패널에서 올바른 시트 선택 |
| 행 수가 0으로 표시 | 헤더만 있고 데이터 없음 | 데이터가 첫 번째 행(헤더) 바로 아래부터 시작하는지 확인 |

### 9.2 매칭 관련 문제

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| 대부분 "Not Found" | 제품명 형식 불일치 | Mapping 파일을 활용하여 수동 매핑 추가 |
| 매칭 점수가 낮음 | 제품명에 농도/규격 등 부가정보 포함 | 정규화 과정에서 제거되지만, 매핑 파일이 더 정확 |
| 잘못된 제품에 매칭 | 유사한 이름의 다른 제품 존재 | Review Threshold를 높이고 (예: 0.95), 검토필요 항목 수동 확인 |
| Generic 수가 예상과 다름 | 옵션 설정 차이 | Generic Count Basis (base vs base+form)와 Cancel Filter 설정 확인 |

### 9.3 제네릭 집계 문제

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| Consistency Check 불일치 오류 | 내부 로직 불일치 | 콘솔 로그에서 해당 순번 확인 후, 해당 성분의 MFDS 데이터 검토 |
| Generic Items가 비어있음 | 해당 성분에 제네릭 없음 | 신약이거나 단독 성분일 수 있음. MFDS 마스터에서 해당 성분 확인 |
| 원개발 제품이 Generic에 포함 | Generic Definition 옵션 | "Exclude original" 옵션이 선택되어 있는지 확인 |

### 9.4 Excel 출력 문제

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| 다운로드가 시작되지 않음 | 브라우저 팝업 차단 | 팝업 차단 해제 또는 다운로드 허용 설정 |
| Excel 파일이 깨져 보임 | 인코딩 문제 | 최신 버전의 Excel에서 열기. LibreOffice에서도 호환 가능 |
| generic_product_names_joined 잘림 | 5000자 제한 | 상세 내용은 generic_items 시트에서 확인 |

### 9.5 성능 문제

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| 처리 시간이 매우 오래 걸림 | 대용량 MFDS 마스터 파일 | Cancel Filter를 "Active only"로 설정하여 처리 대상 축소 |
| 브라우저가 멈춤 | 메모리 부족 | 파일 크기를 줄이거나, 불필요한 탭/프로그램 종료 후 재시도 |
| Progress bar가 멈춤 | 매칭 루프에서 지연 | 잠시 대기 후에도 진행되지 않으면 페이지 새로고침 후 재시도 |

### 9.6 주성분 정규화 관련

| 증상 | 원인 | 해결 방법 |
|------|------|-----------|
| Ingredient_eng이 비어있음 | 주성분 필드에 영문명이 없음 | MFDS 마스터의 주성분 컬럼에 영문명이 괄호 안에 포함되어야 함 (예: `아세트아미노펜(Acetaminophen)`) |
| Ingredient_base가 다르게 생성 | 정규화 규칙 차이 | 농도, 단위, 특수문자가 제거된 후의 결과 확인. 매핑 파일로 보정 가능 |
